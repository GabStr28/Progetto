#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "definizione.h"
#define MAXNOME 30
#define MAXTIPO 30        //dimensione array
#define DIM 100
#define SPORTELLI 3


int main() {
    printf("Benvenuto allo sportello postale.\n");
    Coda sportelli[SPORTELLI];
    for (int i = 0; i < SPORTELLI; i++) initCoda(&sportelli[i]);

    Nodo *storico = NULL;
    NodoPila *undo = NULL;
    Cliente elenco[DIM];
    int nServiti = 0;
    int ciclo=1;
    int scelta, tipo, numeroProgressivo = 1;
    char nome[MAXNOME];

    menuInput(&scelta);

    while(ciclo!=0) {
        switch (scelta) {
            case 0: {
                printf("Arrivederci, grazie per averci scelto.\n");

                return 0;
            }

            case 1: {
                Cliente cl;
                cl.numero = numeroProgressivo++;
                printf("Nome cliente: ");
                scanf("%29s", nome);
                strcpy(cl.nome, nome);

                printf("Tipo (1=Bollette, 2=Pacchi, 3=Spedizioni): ");
                scanf("%d", &tipo);
                if (tipo < 1 || tipo > SPORTELLI) {
                    printf("Tipo non valido.\n");
                    numeroProgressivo--;
                    break;
                }

                if (tipo == 1) strcpy(cl.tipoOperazione, "Bollette");
                else if (tipo == 2) strcpy(cl.tipoOperazione, "Pacchi");
                else strcpy(cl.tipoOperazione, "Spedizioni");

                if (enqueue(&sportelli[tipo-1], cl)) {
                    printf("Assegnato numero %d a %s (%s)\n",
                           cl.numero, cl.nome, cl.tipoOperazione);
                } else {
                    numeroProgressivo--;
                }
                break;
            }

            case 2: {
                printf("Quale sportello servire (1-3)? ");
                scanf("%d", &tipo);
                if (tipo < 1 || tipo > SPORTELLI) {
                    printf("Sportello non valido.\n");
                    break;
                }

                if (!codaVuota(&sportelli[tipo-1])) {
                    Cliente servito = dequeue(&sportelli[tipo-1]);
                    printf("Servendo %s (num %d) allo sportello %d (%s)\n",
                           servito.nome, servito.numero, tipo, servito.tipoOperazione);

                    inserisciInLista(&storico, servito);
                    elenco[nServiti++] = servito;
                    inserimento(&undo, servito);
                    salvaClienteTesto(servito);
                    salvaClienteBin(servito);
                } else {
                    printf("Nessun cliente in attesa!\n");
                }
                break;
            }
          default:
                 printf("Comando non valido!\n");
                 break;
         }

         menuInput(&scelta);
     }

}
